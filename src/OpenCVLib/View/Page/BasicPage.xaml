<UserControl
    x:Class="OpenCVLab.View.Page.BasicPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:OpenCVLab.View.Page"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://Yu-UI.com//2024/xaml"
    d:DataContext="{d:DesignInstance local:BasicPage,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="1000"
    d:DesignWidth="1800"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!--  Card 1: Menu Bar  -->
        <Border
            Grid.Row="0"
            Margin="0,0,0,12"
            Style="{StaticResource BorderRegion}">
            <Menu>
                <MenuItem Header="文件操作">
                    <MenuItem.Icon>
                        <ui:Icon Kind="Image"/>
                    </MenuItem.Icon>

                    <MenuItem Command="{Binding ViewModel.OpenImageCommand}"
                              Header="打开图像">
                        <MenuItem.Icon>
                            <ui:Icon Kind="OpenInBrowser"/>
                        </MenuItem.Icon>
                    </MenuItem>

                    <MenuItem Command="{Binding ViewModel.SaveImageCommand}"
                              Header="保存图像">
                        <MenuItem.Icon>
                            <ui:Icon Kind="DropSaver"/>
                        </MenuItem.Icon>
                    </MenuItem>

                    <MenuItem Command="{Binding ViewModel.ShowImageCommand}"
                              Header="显示图像(CV2)">
                        <MenuItem.Icon>
                            <ui:Icon Kind="ShowOutline"/>
                        </MenuItem.Icon>
                    </MenuItem>
                </MenuItem>

                <MenuItem Header="基础操作">
                    <MenuItem.Icon>
                        <ui:Icon Kind="User"/>
                    </MenuItem.Icon>

                    <MenuItem Header="色彩空间">
                        <MenuItem.Icon>
                            <ui:Icon Kind="Color"/>
                        </MenuItem.Icon>

                        <MenuItem Command="{Binding ViewModel.ConvertColorCommand}"
                                  Header="颜色空间转换"/>
                    </MenuItem>

                    <MenuItem Header="平滑图像(Blur)">
                        <MenuItem.Icon>
                            <ui:Icon Kind="ImageFilterBlackWhite"/>
                        </MenuItem.Icon>

                        <MenuItem Command="{Binding ViewModel.NormalizedBlockFilterCommand}"
                                  Header="归一化滤波"/>
                        <MenuItem Command="{Binding ViewModel.GaussianFilterCommand}"
                                  Header="高斯滤波"/>
                        <MenuItem Command="{Binding ViewModel.MedianFilterCommand}"
                                  Header="中值滤波"/>
                        <MenuItem Command="{Binding ViewModel.BilateralFilterCommand}"
                                  Header="双边滤波"/>
                    </MenuItem>

                    <MenuItem Header="形态学">
                        <MenuItem.Icon>
                            <ui:Icon Kind="Blur"/>
                        </MenuItem.Icon>

                        <MenuItem Command="{Binding ViewModel.DilateCommand}"
                                  Header="膨胀">
                            <MenuItem.ToolTip>
                                <Image Source="pack://application:,,,/OpenCVLab;component/Resources/Tips/MorphologyEx/Morphology_2_Tutorial_Theory_Dilation.png"/>
                            </MenuItem.ToolTip>
                        </MenuItem>

                        <MenuItem Command="{Binding ViewModel.ErodeCommand}"
                                  Header="腐蚀">
                            <MenuItem.ToolTip>
                                <Image Source="pack://application:,,,/OpenCVLab;component/Resources/Tips/MorphologyEx/Morphology_2_Tutorial_Theory_Erosion.png"/>
                            </MenuItem.ToolTip>
                        </MenuItem>

                        <MenuItem Header="高级形态学变换">
                            <MenuItem Command="{Binding ViewModel.MorphologyExOpenCommand}"
                                    Header="开运算"/>
                            <MenuItem Command="{Binding ViewModel.MorphologyExCloseCommand}"
                                    Header="闭运算"/>
                            <MenuItem Command="{Binding ViewModel.MorphologyExGradientCommand}"
                                    Header="梯度"/>
                            <MenuItem Command="{Binding ViewModel.MorphologyExTopHatCommand}"
                                    Header="顶帽"/>
                            <MenuItem Command="{Binding ViewModel.MorphologyExBlackHatCommand}"
                                    Header="黑帽"/>
                        </MenuItem>
                    </MenuItem>

                    <MenuItem Header="阈值处理">
                        <MenuItem.Icon>
                            <ui:Icon Kind="Contrast"/>
                        </MenuItem.Icon>

                        <MenuItem Command="{Binding ViewModel.ThresholdCommand}"
                                  Header="简单阈值"/>
                        <MenuItem Command="{Binding ViewModel.AdaptiveThresholdCommand}"
                                  Header="自适应阈值"/>
                    </MenuItem>

                    <MenuItem Header="边缘检测">
                        <MenuItem.Icon>
                            <ui:Icon Kind="VectorLine"/>
                        </MenuItem.Icon>

                        <MenuItem Command="{Binding ViewModel.CannyCommand}"
                                  Header="Canny边缘检测"/>
                        <MenuItem Command="{Binding ViewModel.SobelCommand}"
                                  Header="Sobel边缘检测"/>
                        <MenuItem Command="{Binding ViewModel.LaplacianCommand}"
                                  Header="Laplacian边缘检测"/>
                    </MenuItem>

                    <MenuItem Header="图像变换">
                        <MenuItem.Icon>
                            <ui:Icon Kind="Transform"/>
                        </MenuItem.Icon>

                        <MenuItem Header="缩放"
                                IsEnabled="False"
                                ToolTip="暂未实现"/>
                        <MenuItem Header="旋转"
                                IsEnabled="False"
                                ToolTip="暂未实现"/>
                        <MenuItem Header="仿射变换"
                                IsEnabled="False"
                                ToolTip="暂未实现"/>
                        <MenuItem Header="透视变换"
                                IsEnabled="False"
                                ToolTip="暂未实现"/>
                    </MenuItem>
                </MenuItem>

                <MenuItem Header="高级操作">
                    <MenuItem.Icon>
                        <ui:Icon Kind="MagicWand"/>
                    </MenuItem.Icon>

                    <MenuItem Header="直方图">
                        <MenuItem.Icon>
                            <ui:Icon Kind="ChartBar"/>
                        </MenuItem.Icon>

                        <MenuItem Command="{Binding ViewModel.EqualizeHistCommand}"
                                  Header="直方图均衡化"/>
                        <MenuItem Command="{Binding ViewModel.DrawHistCommand}"
                                  Header="计算直方图"/>
                    </MenuItem>

                    <MenuItem Header="轮廓查找">
                        <MenuItem.Icon>
                            <ui:Icon Kind="ShapeOutline"/>
                        </MenuItem.Icon>

                        <MenuItem Command="{Binding ViewModel.FindContoursCommand}"
                                  Header="查找轮廓"/>
                        <MenuItem Command="{Binding ViewModel.DrawBoundingRectCommand}"
                                  Header="绘制轮廓矩形"/>
                    </MenuItem>

                    <MenuItem Header="模板匹配">
                        <MenuItem.Icon>
                            <ui:Icon Kind="ImageSearch"/>
                        </MenuItem.Icon>

                        <MenuItem Header="模板匹配"
                                IsEnabled="False"
                                ToolTip="暂未实现"/>
                    </MenuItem>
                </MenuItem>
            </Menu>
        </Border>

        <!--  Card 2: Main Image Display  -->
        <Border
            Grid.Row="1"
            Margin="0,0,0,12"
            Padding="0"
            Style="{StaticResource BorderRegion}">
            <Grid ClipToBounds="True">
                <ui:ImagePreviewControl
                    x:Name="uiImagePreviewControl"
                    Background="{StaticResource OpenCVLab.Brush.Background}"
                    ImageSource="{Binding ViewModel.SelectOperation.BitmapSource}"/>

                <Expander
                    Margin="16"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    ExpandDirection="Down"
                    IsExpanded="True">
                    <Expander.Header>
                        <TextBlock
                            FontWeight="SemiBold"
                            Foreground="{StaticResource OpenCVLab.Brush.Text}"
                            Text="图像信息"/>
                    </Expander.Header>
                    <Border
                        Padding="12"
                        Background="{StaticResource OpenCVLab.Brush.Surface}"
                        CornerRadius="8"
                        Effect="{StaticResource EffectShadowSmall}">
                        <StackPanel>
                            <StackPanel Margin="2"
                                        Orientation="Horizontal">
                                <TextBlock Foreground="{StaticResource OpenCVLab.Brush.TextMuted}"
                                        Text="通道数："/>
                                <TextBlock
                                    Margin="4,0"
                                    VerticalAlignment="Center"
                                    FontWeight="Medium"
                                    Text="{Binding ViewModel.SelectOperation.Channels}"/>
                            </StackPanel>

                            <StackPanel Margin="2"
                                        Orientation="Horizontal">
                                <TextBlock Foreground="{StaticResource OpenCVLab.Brush.TextMuted}"
                                        Text="维度："/>
                                <TextBlock
                                    Margin="4,0"
                                    VerticalAlignment="Center"
                                    FontWeight="Medium"
                                    Text="{Binding ViewModel.SelectOperation.ImageMat.Dims}"/>
                            </StackPanel>

                            <StackPanel Margin="2"
                                        Orientation="Horizontal">
                                <TextBlock Foreground="{StaticResource OpenCVLab.Brush.TextMuted}"
                                        Text="尺寸："/>
                                <TextBlock
                                    Margin="4,0"
                                    VerticalAlignment="Center"
                                    FontWeight="Medium"
                                    Text="{Binding ViewModel.SelectOperation.ImageMat.Cols}"/>
                                <TextBlock Margin="2,0"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource OpenCVLab.Brush.TextMuted}">
                                    ×
                                </TextBlock>
                                <TextBlock
                                    Margin="4,0"
                                    VerticalAlignment="Center"
                                    FontWeight="Medium"
                                    Text="{Binding ViewModel.SelectOperation.ImageMat.Rows}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Expander>

                <Image
                    Width="300"
                    Height="150"
                    Margin="16"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Bottom"
                    Effect="{StaticResource EffectShadow3}"
                    Source="{Binding ViewModel.HistImageSource}"/>

                <Expander
                    Margin="16"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    ExpandDirection="Right"
                    IsExpanded="False">
                    <Expander.Header>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontWeight="SemiBold"
                                    Foreground="{StaticResource OpenCVLab.Brush.Text}">
                                <TextBlock.LayoutTransform>
                                    <RotateTransform Angle="90"/>
                                </TextBlock.LayoutTransform>
                                操
                            </TextBlock>
                            <TextBlock FontWeight="SemiBold"
                                    Foreground="{StaticResource OpenCVLab.Brush.Text}">
                                <TextBlock.LayoutTransform>
                                    <RotateTransform Angle="90"/>
                                </TextBlock.LayoutTransform>
                                作
                            </TextBlock>
                        </StackPanel>
                    </Expander.Header>

                    <Border
                        Padding="8"
                        Background="{StaticResource OpenCVLab.Brush.Surface}"
                        CornerRadius="8"
                        Effect="{StaticResource EffectShadowSmall}">
                        <StackPanel HorizontalAlignment="Left"
                                    VerticalAlignment="Center">
                            <ToggleButton Unchecked="ClearCanvas"
                                          Checked="DrawBoundingRectCanvas"
                                          Content="绘制轮廓矩形"
                                          Style="{StaticResource ToggleButtonSwitch}"/>
                        </StackPanel>
                    </Border>
                </Expander>
            </Grid>
        </Border>

        <!--  Card 3: Operation History  -->
        <Border
            Grid.Row="2"
            Height="160"
            Style="{StaticResource BorderRegion}">
            <ListBox
                Margin="8"
                d:ItemsSource="{d:SampleData ItemCount=5}"
                ItemsSource="{Binding ViewModel.OperationsCollection}"
                SelectedItem="{Binding ViewModel.SelectOperation}"
                ScrollViewer.HorizontalScrollBarVisibility="Auto"
                ScrollViewer.VerticalScrollBarVisibility="Disabled">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="4">
                            <Border CornerRadius="6"
                                    ClipToBounds="True">
                                <Image
                                    Width="180"
                                    Height="100"
                                    Stretch="UniformToFill"
                                    Source="{Binding BitmapSource}"/>
                            </Border>
                            <TextBlock
                                Width="180"
                                Margin="0,6,0,0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Text="{Binding DisplayName}"
                                TextTrimming="CharacterEllipsis"
                                TextWrapping="NoWrap"
                                Foreground="{StaticResource OpenCVLab.Brush.Text}"
                                FontSize="12"/>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Background"
                                Value="Transparent"/>
                        <Setter Property="BorderThickness"
                                Value="0"/>
                        <Setter Property="Margin"
                                Value="4,0"/>
                        <Setter Property="Padding"
                                Value="4"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Border x:Name="Bd"
                                            Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="8"
                                            Padding="{TemplateBinding Padding}"
                                            SnapsToDevicePixels="true">
                                        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                          SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver"
                                                Value="True">
                                            <Setter TargetName="Bd"
                                                    Property="Background"
                                                    Value="{StaticResource OpenCVLab.Brush.Hover}"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected"
                                                Value="True">
                                            <Setter TargetName="Bd"
                                                    Property="Background"
                                                    Value="{StaticResource OpenCVLab.Brush.Accent.Light}"/>
                                            <Setter TargetName="Bd"
                                                    Property="BorderBrush"
                                                    Value="{StaticResource OpenCVLab.Brush.Accent}"/>
                                            <Setter TargetName="Bd"
                                                    Property="BorderThickness"
                                                    Value="1"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ContextMenu>
                    <ContextMenu>
                        <MenuItem Command="{Binding ViewModel.DeleteOperationCommand}"
                                  Header="删除选中"/>
                    </ContextMenu>
                </ListBox.ContextMenu>
            </ListBox>
        </Border>
    </Grid>
</UserControl>
